---
title: "Polymerase fidelity estimates"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load required libraries, load and merge MAGERI results.

```{r}
library(plyr); library(ggplot2); library(reshape2); library(gplots)

load_variant_table <- function(path, project, sample) {
  fname <- paste(path, paste(project, sample, "variant.caller.txt", sep ="."), sep = "/")
  df.1 <- read.table(fname, header=T, sep="\t")
  df.1$project <- project
  df.1$sample <- sample
  df.1
}

# mutation signatures
sign.rep <- data.frame(mutation.signature = c("A>C","A>G","A>T","C>A","C>G","C>T","G>A","G>C","G>T","T>A","T>C","T>G"),
                       mutation.signature.rep = c("A>C,T>G","A>G,T>C","A>T,T>A","C>A,G>T","C>G,G>C","C>T,G>A","C>T,G>A","C>G,G>C","C>A,G>T","A>T,T>A","A>G,T>C","A>C,T>G"))

read_data <- function(path) {
  df.meta <- read.table(paste(path, "metadata.txt", sep="/"), header=T, sep = "\t")

  # load and concatenate all samples
  df <- data.frame()
  
  for (i in 1:nrow(df.meta)) {
    df <- rbind(df, load_variant_table(path, df.meta$project[i], df.meta$sample[i]))
  }
  
  # append metadata
  df <- merge(df, df.meta, all.x=T, all.y=F)
  
  # split mutation signature
  df$mut.split <- sapply(df$mutation, function(x) strsplit(as.character(x),"[S:>]"))
  df$mutation.pos <- as.integer(sapply(df$mut.split, function(x) x[2]))
  df$mutation.from <- sapply(df$mut.split, function(x) x[3])
  df$mutation.to <- sapply(df$mut.split, function(x) x[4])
  df$mut.split  <- NULL
  
  # mutation signature groups
  df$mutation.signature <- paste(df$mutation.from, df$mutation.to, sep =">")
  df <- merge(df, sign.rep, all.x=T, all.y=F)
  
  # exclude bases that are not in reference
  df <- subset(df, !(mutation.pos %in% 22:25))
  
  # shift back mutations
  df$mutation.pos <- ifelse(df$mutation.pos > 25, df$mutation.pos - 4, df$mutation.pos)
  
  df$mutation <- with(df, paste("S", mutation.pos, ":", mutation.from, ">", mutation.to, sep=""))
  
  df
}

df <- read_data("polerr2016")
df.linpcr <- read_data("polerr73-82")

template <- "TAGCGTGAAGACGACAGAACCATGGGATCCATTATCGGCGGCGAATTTACCACCATTGAAAACCAGCCGTGGTTTGCGGCGATTTATCGTCGTCATCGTGGCGGCAGCGTGACCTATGTGTGCGGCGGCAGCCTGATTAGCCCGTGCTGG"
```

## Estimating the error rates

In this section we compute linear PCR error rate from Proj73/82 and error rate in conventional PCR from Polerr2016 project. Note that the linear PCR error rate is substantially higher than rate per cycle of conentional PCR. For some cases, e.g. Phusion it accounts for ~1/2 of errors observed in Polerr2016.

```{r}
library(knitr)

# Compute linear PCR error rate

df.er.linpcr <- ddply(df.linpcr, .(project, name), summarize, mismatches = sum(count.major), umi.count = mean(coverage))
df.er.linpcr <- ddply(df.er.linpcr, .(name), summarize, mismatches = sum(mismatches), umi.count = round(sum(umi.count)))

df.er.linpcr <- data.frame(name = df.er.linpcr$name, linpcr.er = df.er.linpcr$mismatches/df.er.linpcr$umi.count/nchar(template))

# Compute uncrorrected error rate

df.er <- ddply(df, .(project, name, cycles), summarize, 
               mismatches = sum(count.major), umi.count = round(mean(coverage)))

df.er <- merge(df.er, df.er.linpcr, by = "name", all.x = T)

df.er$err.rate <- with(df.er, mismatches / umi.count / nchar(template) / mean(cycles))
df.er$delta <- with(df.er, sqrt(mismatches / umi.count * (1 - mismatches / umi.count) / umi.count) / 
                 nchar(template) / mean(cycles))
df.er$err.lb <- df.er$err.rate - 1.96 * df.er$delta
df.er$err.ub <- df.er$err.rate + 1.96 * df.er$delta

# Error rates corrected for linear PCR errors

df.er$mismatches.corr <- with(df.er, mismatches - linpcr.er * umi.count * nchar(template))
df.er$err.rate.corr <- with(df.er, mismatches.corr / umi.count / nchar(template) / mean(cycles))
df.er$delta.corr <- with(df.er, sqrt(mismatches.corr / umi.count * (1 - mismatches.corr / umi.count) / umi.count) / 
                 nchar(template) / mean(cycles))
df.er$err.lb.corr <- df.er$err.rate.corr - 1.96 * df.er$delta.corr
df.er$err.ub.corr <- df.er$err.rate.corr + 1.96 * df.er$delta.corr

df.er$cycles <- NULL

kable(df.er)

write.table(df.er, file="er.txt", quote=F, sep="\t", row.names = F)
```

Error rate consistency between two independent experimental replicas from Polerr2016 dataset.

```{r}
df.er.cast <- dcast(df.er, name ~ project, 
                    value.var = "err.rate.corr")
df.er.cast2 <- dcast(df.er, name ~ project, 
                    value.var = "delta")

df.er.cast <- merge(df.er.cast, df.er.cast2, by = "name")
colnames(df.er.cast) <- c("name", "replica1.x", "replica2.x", "replica1.y", "replica2.y")

m <- lm(replica1.x ~ replica2.x, df.er.cast);
eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(R)~"="~r,
     list(a = format(coef(m)[1], digits = 2),
          b = format(coef(m)[2], digits = 2),
          r = format(sqrt(summary(m)$r.squared), digits = 2)))
lbl<-as.character(as.expression(eq))

ggplot(df.er.cast, aes(x=replica1.x, y=replica2.x)) + 
  geom_errorbarh(aes(xmax=replica1.x+1.96*replica1.y,xmin=replica1.x-1.96*replica1.y)) +
  geom_errorbar(aes(ymax=replica2.x+1.96*replica2.y,ymin=replica2.x-1.96*replica2.y)) +
  geom_smooth(method = "lm", color="black", fill="grey80", fullrange = T) + 
  geom_point(size=2, shape=21, fill="grey70") + 
  geom_text(aes(label=name), vjust=1, hjust = .3, color="red") + 
  geom_label(aes(x = 1e-6, y = 8e-5, label = lbl), hjust=-0.1, parse = TRUE)+
  scale_x_log10(name="Error rate in experiment 1, 1/bp/cycle", limits=c(1e-6,1e-4)) + 
  scale_y_log10(name="Error rate in experiment 2, 1/bp/cycle", limits=c(1e-6,1e-4)) +  
  theme_bw()
```

## Error substitution patterns

Combine error rates from Polerr2016 replicas, summarize it by substitution type and polymerase.

```{r}
df.coverage.summary <- ddply(df, .(name, project), summarize, coverage = mean(coverage))
df.coverage.summary <- ddply(df.coverage.summary, .(name), summarize, coverage = sum(coverage))

df <- ddply(df, .(name, mutation), summarize, count.major = sum(count.major))

df <- merge(df, df.coverage.summary, by = "name")
```

Substitution signature preferences

```{r}
df.pattern <- ddply(df, .(name, mutation.signature.rep), summarize, count.sum = sum(count.major))
df.pattern <- ddply(df.pattern, .(name), transform, freq = count.sum / sum(count.sum))

ggplot(df.pattern, aes(x = mutation.signature.rep, weight = freq, 
               fill = name)) + geom_bar(position = position_dodge()) +
  xlab("Substitution signature") + scale_y_continuous("Share of errors", expand=c(0,0)) +
  scale_fill_brewer(palette = "Paired") + theme_bw()
```

```{r}
library(RColorBrewer)
df.1$freq <- df.1$count.major / df.1$coverage
df.1$name_proj <- paste(df.1$name, ifelse(df.1$project == "polerr2016-1", "1", "2"), sep="-")
mat.profile <- dcast(df.1, name_proj ~ mutation, value.var = "freq")
rownames(mat.profile) <- mat.profile[,1]
mat.profile[,1] <- NULL
mat.profile <- t(as.matrix(mat.profile))
mat.profile[is.na(mat.profile)] <- 0

df.aux <- unique(data.frame(mutation = df$mutation, signature = df$mutation.signature.rep))
df.aux$mutation <- as.character(df.aux$mutation)

df.color <- merge(data.frame(mutation = rownames(mat.profile)), df.aux)

df.color <- merge(df.color, data.frame(colors = brewer.pal(6, "Paired"), signature = levels(df.color$signature)))

rowcolor <- as.character(df.color$colors)
names(rowcolor) <- df.color$mutation

rowDend <- hclust(dist(mat.profile))
colDend <- hclust(as.dist((1-cor(mat.profile, method = "spearman"))/2), method = "ward")

heatmap.2(log10(mat.profile), col=c("#67001f", colorpanel(99, "#b2182b", "#f7f7f7", "#2166ac")),
          dendrogram = "both", RowSideColors = rowcolor, breaks = seq(-6,-2,length.out = 101),
          Rowv = as.dendrogram(rowDend), 
          Colv = as.dendrogram(colDend),
          density.info = "none", trace="none")
```

Transitions and transversions:

```{r}

```

This goes to supplementary. Clear preference of substitution patters for different polymerases, but no strong position-related trend.

```{r}
ggplot(df, aes(x = mutation.pos, weight = count.major / coverage, fill = mutation.from)) + 
  geom_histogram(bins = nchar(template)) + scale_fill_brewer("Substituted base", palette = "Set1") +
  xlab("Position on template") + ylab("Error rate") +
  facet_wrap(~name) + theme_bw()

a <- aov(count.major / coverage ~ mutation.pos + mutation.from, df)
summary(a)
```

Same for linear PCR.

```{r}
df.coverage.summary <- ddply(df.linpcr, .(name, project), summarize, coverage = mean(coverage))
df.coverage.summary <- ddply(df.coverage.summary, .(name), summarize, coverage = sum(coverage))

df.linpcr <- ddply(df.linpcr, .(name, mutation), summarize, count.major = sum(count.major))

df.linpcr <- merge(df.linpcr, df.coverage.summary, by = "name")

df.linpcr$mut.split <- sapply(df.linpcr$mutation, function(x) strsplit(as.character(x),"[S:>]"))
df.linpcr$mutation.pos <- as.integer(sapply(df.linpcr$mut.split, function(x) x[2]))
df.linpcr$mutation.from <- sapply(df.linpcr$mut.split, function(x) x[3])
df.linpcr$mutation.to <- sapply(df.linpcr$mut.split, function(x) x[4])
df.linpcr$mut.split  <- NULL

df.linpcr$mutation.signature <- paste(df.linpcr$mutation.from, df.linpcr$mutation.to, sep =">")

sign.rep <- data.frame(mutation.signature = c("A>C","A>G","A>T","C>A","C>G","C>T","G>A","G>C","G>T","T>A","T>C","T>G"),
                       mutation.signature.rep = c("A>C,T>G","A>G,T>C","A>T,T>A","C>A,G>T","C>G,G>C","C>T,G>A","C>T,G>A","C>G,G>C","C>A,G>T","A>T,T>A","A>G,T>C","A>C,T>G"))

df.linpcr <- merge(df.linpcr, sign.rep, all.x=T, all.y=F)

df.pattern <- ddply(df.linpcr, .(name, mutation.signature.rep), summarize, count.sum = sum(count.major))
df.pattern <- ddply(df.pattern, .(name), transform, freq = count.sum / sum(count.sum))

ggplot(df.pattern, aes(x = mutation.signature.rep, weight = freq, 
               fill = name)) + geom_bar(position = position_dodge()) +
  xlab("Substitution signature") + scale_y_continuous("Share of errors", expand=c(0,0)) +
  scale_fill_brewer(palette = "Paired") + theme_bw()


df.pattern.mat <- dcast(df.pattern, name ~ mutation.signature.rep, value.var = "freq")
rownames(df.pattern.mat) <- df.pattern.mat$name
df.pattern.mat$name <- NULL

df.pattern.mat <- as.matrix(df.pattern.mat)
df.pattern.mat[is.na(df.pattern.mat)] <- 0

heatmap.2(df.pattern.mat, col=colorpanel(100, "#b2182b", "#f7f7f7", "#2166ac"),
          dendrogram = "row", Colv=F,
          density.info = "none", trace="none")

x.ti <- rowSums(df.pattern.mat[,c("A>G,T>C","C>T,G>A")])
x.tv <- rowSums(df.pattern.mat) - x.ti

df.trans <- as.data.frame(cbind(x.ti, x.tv))
df.trans$titv <- df.trans$x.ti / df.trans$x.tv
colnames(df.trans) <- c("transitions", "transversions", "Ti/Tv")

kable(df.trans)
```

## Recurrent errors

```{r}
df.1x <- ddply(subset(df.1, project == "polerr2016-1"), .(name, mutation), summarize,
               freq = count.major / coverage, coverage = coverage)

df.1y <- ddply(subset(df.1, project == "polerr2016-2"), .(name, mutation), summarize,
               freq = count.major / coverage, coverage = coverage)

df.1 <- merge(df.1x, df.1y, by=c("name","mutation"), all = T)
mask1 <- is.na(df.1$freq.x)
mask2 <- is.na(df.1$freq.y)
df.1$miss <- mask1 | mask2

df.1 <- ddply(df.1, .(name), transform, 
              freq.x = ifelse(is.na(freq.x), 1/mean(coverage.x, na.rm = T), freq.x),
              freq.y = ifelse(is.na(freq.y), 1/mean(coverage.y, na.rm = T), freq.y))

ggplot() + 
  geom_point(data=subset(df.1, !miss), aes(x=freq.x, y=freq.y), shape=21) + 
  geom_smooth(data=subset(df.1, !miss & name != "Phusion"), aes(x=freq.x, y=freq.y), method="lm") + 
  geom_point(data=subset(df.1, miss), aes(x=freq.x, y=freq.y), shape=21, color="red") + 
  facet_wrap(~name) +
  scale_x_log10("Frequency in experiment 1", limits=c(1e-6,1e-2)) + 
  scale_y_log10("Frequency in experiment 2", limits=c(1e-6,1e-2)) + 
  theme_bw()
```

## Error hotspot context pattern

Frequency distribution of individual mutations, grouped by their pattern.

```{r}
df.mean.err <- ddply(df, .(name), summarize, mean.err.rate = sum(count.major) / mean(coverage) / nchar(template))
# ^ this one is the gloal mean

df <- merge(df, df.mean.err, all.x=T, all.y=F)

ggplot(df) + 
  geom_histogram(aes(x = count.major / coverage, fill = mutation.signature.rep)) + 
  geom_linerange(aes(x = mean.err.rate, ymin = 0, ymax=50), linetype = "dashed", color="black") +
  scale_fill_brewer("Substitution signature", palette = "Paired") +
  scale_x_log10("Error frequency") + 
  scale_y_continuous("", expand=c(0,0)) + facet_wrap(~name) + theme_bw()
  #facet_wrap(~name, scales = "free_y") + theme_bw()
```

## Sequence quality and error patterns

```{r}
df.q <- read.table("polerr73-82/mmqc.txt", header=T,sep="\t")
library(reshape2)
df.q <- melt(df.q, id.vars = "qual.threshold")

df.q <- merge(df.q, 
              data.frame(variable = unlist(strsplit("A.C;T.G;A.G;T.C;A.T;T.A;C.A;G.T;C.G;G.C;C.T;G.A", ";")),
                         pattern = unlist(strsplit("A>C,T>G;A>C,T>G;A>G,T>C;A>G,T>C;A>T,T>A;A>T,T>A;C>A,G>T;C>A,G>T;C>G,G>C;C>G,G>C;C>T,G>A;C>T,G>A", ";"))
), by = "variable")

df.q <-ddply(df.q, .(qual.threshold, pattern), summarize, value=sum(value))

ggplot(df.q, aes(x=qual.threshold, color=pattern, y=value)) + 
  geom_smooth() + geom_point() + scale_y_log10() +
  scale_color_brewer(palette = "Paired") + theme_bw()
```

## UMI coverage

UMI coverage histogram

```{r}
df.meta <- read.table(paste("polerr2016", "metadata.txt", sep="/"), header=T, sep = "\t")

df.h <- data.frame(mig.size.bin = integer(), read.count = integer(), name=character(), project=character())

for (proj in unique(df.meta$project)) {
  for (sample in unique(subset(df.meta, project == proj)$sample)) {
    mask <- which(df.meta$sample == sample & df.meta$project == proj)
    name <- df.meta$name[mask][1]
    cycles_2 <- df.meta$cycles_2[mask][1]
    df.hh <- read.table(paste("polerr2016", paste(proj, sample, "umi.histogram.txt", sep="."), sep="/"), 
                        header=T, sep="\t")
    df.h <- rbind(df.h, data.frame(mig.size.bin = df.hh$mig.size.bin, read.count = df.hh$read.count, 
                                   name=name, project=proj, cycles_2=cycles_2))
  }
}


ggplot(df.h) + 
  geom_rect(aes(xmin=1, xmax=5, ymin=0, ymax=Inf), fill="grey") +
  geom_line(aes(x=mig.size.bin, y=read.count, color=project, linetype=name, 
                group = interaction(project, name)), size=1) + 
  scale_x_log10("UMI coverage", limits = c(1,1e6), expand=c(0,0)) + 
  scale_y_continuous("Number of reads in UMIs", expand=c(0,0), limits=c(0,1.5e7)) +
  scale_color_brewer(palette = "Set1") +
  theme_bw()
```

Coverage and PCR cycles

```{r}
df.o <- ddply(df.h, .(project, name, cycles_2), summarize, 
              peak = log2(mig.size.bin[which(read.count == max(read.count))]))

m <- lm(peak ~ cycles_2, df.o)
eq <- substitute(italic(R)~"="~r*","~~italic(P)~"="~p,
     list(
     r = format(sqrt(summary(m)$r.squared), digits = 2),
     p = format(summary(m)$coefficient[[8]], digits = 3)
     ))
lbl<-as.character(as.expression(eq))

ggplot()+
geom_label(aes(x = 22, y = 12, label = lbl), hjust=-0.1, parse = TRUE)+
stat_smooth(data=df.o, aes(cycles_2, peak), method=lm, color="black", fill="grey80") + 
geom_jitter(data=df.o, aes(cycles_2, peak, fill=name), size=3, width=0.3, height=0.3, color="black", shape=21) +
#geom_text(aes(cycles_2,peak,label=name, vjust=1, hjust = .3)) +
scale_x_continuous(name="2nd PCR cycles", breaks=10:30) +
scale_y_continuous(expression('log'[2]~'characteristic MIG size'), breaks=2:20) +
scale_fill_brewer(name  ="Polymerase", palette = "Paired") +
theme_bw()

```